<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login â€“ Invoice Management System</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<div class="login-box">
    <div class="logo-section">
        <i class="fas fa-file-invoice-dollar"></i>
        <h2>Invoice Management System</h2>
        <p>Sign in to your account</p>
    </div>

    <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="input-group">
            <label for="email">
                <i class="fas fa-envelope"></i>
                Email Address
            </label>
            <input
                type="email"
                id="email"
                placeholder="admin@test.com"
                required
                autocomplete="email"
            >
        </div>

        <div class="input-group">
            <label for="password">
                <i class="fas fa-lock"></i>
                Password
            </label>
            <div class="password-wrapper">
                <input
                    type="password"
                    id="password"
                    placeholder="********"
                    required
                    autocomplete="current-password"
                >
                <button type="button" class="toggle-password" onclick="togglePassword()">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>

        <button type="submit" class="login-btn" id="loginBtn">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login</span>
        </button>

        <div id="error" class="error-message"></div>
    </form>

    <div class="footer-info">
      
    </div>
</div>

<script>
function togglePassword() {
    const passwordInput = document.getElementById("password");
    const toggleBtn = document.querySelector(".toggle-password i");

    if (passwordInput.type === "password") {
        passwordInput.type = "text";
        toggleBtn.classList.remove("fa-eye");
        toggleBtn.classList.add("fa-eye-slash");
    } else {
        passwordInput.type = "password";
        toggleBtn.classList.remove("fa-eye-slash");
        toggleBtn.classList.add("fa-eye");
    }
}

function handleLogin(event) {
    event.preventDefault();
    login();
}

function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const error = document.getElementById("error");
    const loginBtn = document.getElementById("loginBtn");

    error.innerText = "";
    loginBtn.classList.add("loading");

    // Frontend validation
    if (!email || !password) {
        error.innerText = "All fields are required";
        loginBtn.classList.remove("loading");
        return;
    }

    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        error.innerText = "Invalid email address";
        loginBtn.classList.remove("loading");
        return;
    }

    // Password validation
    if (password.length < 6) {
        error.innerText = "Password must be at least 6 characters";
        loginBtn.classList.remove("loading");
        return;
    }

    fetch("http://127.0.0.1:5000/login", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            email: email,
            password: password
        })
    })
    .then(res => {
        if (!res.ok) {
            throw new Error("Login failed");
        }
        return res.json();
    })
    .then(data => {
        if (data.access_token) {
            localStorage.setItem("token", data.access_token);
            error.style.color = "#27ae60";
            error.innerText = "Login successful. Redirecting...";

            setTimeout(() => {
                window.location.href = "/invoices";
            }, 1000);
        } else {
            error.innerText = "Invalid email or password";
        }
    })
    .catch(err => {
        console.error("Login error:", err);
        error.innerText = "Server error. Please try again later.";
    })
    .finally(() => {
        loginBtn.classList.remove("loading");
    });
}

// Auto-focus on email field
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("email").focus();
});

// Enter key handling
document.addEventListener("keypress", function(e) {
    if (e.key === "Enter") {
        handleLogin(e);
    }
});
</script>

</body>
</html>
